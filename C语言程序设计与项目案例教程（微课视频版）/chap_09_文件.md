## 文件的概述和基本操作

- 文件概述
  - 文件分类
  
    - 用户角度
      - 普通文件：驻留在磁盘或其他外部介质上的一个有序数据集。
      - 设备文件：与主机相连的各种外部设备。在操作系统中，把外部设备也看做一个文件来进行管理，把它们的输入、输出等同于对磁盘文件的读和写。
    - 文件编码方式
      - ASCII 文件（文本文件）：在磁盘中存放时，每个字符对应 1 字节，用于存放对应的 ASCII 码。
      - 二进制文件：按二进制的编码方式来存放文件。
    - 文件处理方式
      - 缓冲文件系统（标准文件系统、高层文件系统）：常用的文件系统，也是 ANSI C 建议使用的文件系统。通用性好、功能强、使用方便。
      - 非缓冲文件系统（底层文件系统）：与机器有关，有用较为困难，节省内存，执行效率较高。
  
  - 文件指针：用一个指针变量指向文件。对所指的文件进行各种操作
  
    ```c
    FILE * fp;		// fp 为指向一个文件的指针
    ```
  
- 文件的打开、关闭
  - 文件打开函数 fopen()
  
    ```c
    /*
    *	文件指针名 * fopen(文件名, 使用文件方式);
    *	
    *	“文件指针名”：必须是被说明为 FILE 类型的指针变量
    *	“文件名”：被打开文件的文件名，其类型为字符串常量或字符串数组
    *	“使用文件方式”：文件的类型和操作要求
    */
    
    /*
    	打开名为 example.txt 的文件，文件使用的方式为“只读”。
    	fopen()函数返回指向 example.txt 文件的指针并赋给 fp, 即 fp 指向了 example.txt 文件。
    */
    FILE *fp;
    fp = fopen("example.txt", "r");
    
    /*
    	以只读方式打开 C 盘驱动器下文件夹 user 中的文件 cwg.txt 并使文件指针 fp 指向该文件。
    */
    FILE *fp;
    fp = fopen("c:\\user\\cwg.txt", "w");
    ```
  
    
  
    | 文件使用方式    | 含义                     | 说明                                               |
    | --------------- | ------------------------ | -------------------------------------------------- |
    | "rt"（只读）    | 打开文本文件，只读       | 如果指定文件不存在，则出错                         |
    | "wt"（只写）    | 打开文本文件，只写       | 新建一个文件，如果指定文件已存在，则删除它，再新建 |
    | "at"（追加）    | 打开文本文件，追加       | 如果指定文件不存在，则创建该文件                   |
    | "rb"（只读）    | 打开二进制文件，只读     | 如果指定文件不存在，则出错                         |
    | "wb"（只写）    | 打开二进制文件，只写     | 新建一个文件，如果指定文件已存在，则删除它，再新建 |
    | "ab"（追加）    | 打开二进制文件，追加     | 如果指定文件不存在，则创建该文件                   |
    | "rt+"（读写）   | 打开文本文件，读、写     | 如果指定文件不存在，则出错                         |
    | "wt+"（读写）   | 打开文本文件，读、写     | 新建一个文件，如果指定文件已存在，则删除它，再新建 |
    | "at+"（读追加） | 打开文本文件，读、追加   | 如果指定文件不存在，则创建该文件                   |
    | "rb+"（读写）   | 打开二进制文件，读、写   | 如果指定文件不存在，则出错                         |
    | "wb+"（读写）   | 打开二进制文件，读、写   | 新建一个文件，如果指定文件已存在，则删除它，再新建 |
    | "ab+"（都追加） | 打开二进制文件，读、追加 | 如果指定文件不存在，则创建该文件                   |
  
    
  
    - 文件使用方式由r(read)为读、w(write)为写、a(append)为追加、t(text)为文本文件可省略不写、b(二进制文件) 和 +(读和写) 这6个字符组成。
    - 用以上方式可打开文本文件或二进制文件，这是 ANSI C 的规定，即用同一种文件缓冲系统来处理文本文件和二进制文件。
    - 在读取文本文件时，会自动将回车、换行两个字符转换为一个换行符。写入时，会自动将一个换行符转换为回车和换行两个字符。在用二进制文件时，不会进行这种转换。
    - 打开一个文件时，若出错，fopen() 函数将返回一个空指针值 NULL。
  
  - 文件关闭函数 fclose()：使文件指针变量不指向该文件。保证本次文件操作有效。
  
    ```c
    /* 
    	正常完成关闭时，fclose()函数返回值为0；
    	若返回值非零，则表示有错误发生，可用 ferror()函数来调试。
    */
    fclose(fp);	
    ```
  
- 文件的读写
  - 写字符函数 fputc()：
  
    - 被写入的文件可以用写，读写、追加方式打开，用写或读方式打开一个已存在的文件时，将清楚原有的文件内容，写入字符从文件首地址开始。
    - 每写入一个字符，文件内部位置指针向后移动 1 字节。
    - fputc() 函数有一个返回值，若写入成功则返回写入字符，否则返回一个 EOF。可用此判断写入是否成功。
  
  - 读字符函数 fgetc()：
  
    - 在 fgetc() 函数调用中，读取的文件必须是以读或读写方式打开的。
    - 读取字符的结果也可以不向字符变量赋值。
    - 在文件内部有一个位置指针用来指向文件的当前读写字节。在文件打开时，该指针总是指向文件的第1字节。使用 fgetc()函数后，该指针将向后移动1字节，**可连续多次使用 fgetc() 函数读取多个字符**。
  
  - 写字符串函数 fputs()：向指定的文件写入一个字符串。字符串可以是字符串常量、字符数组名、指针型指针变量。
  
    - 字符串末尾的 '\0' 不输出，若输出成功，则函数值返回 0；若失败，则为 EOF。
  
  - 读字符串函数 fgets()：从指定的文件中读一个字符串到字符数组中。
  
    - 在读出 n - 1个字符之前，若遇到换行符或EOF，则读出结束。
    - fgets() 函数也有返回值，其返回值是字符数组的首地址。
  
  - 数据块读写函数 fread() fwrite()：用于整块数据的读写。用来读写一组数据。
  
    ```c
    /*
    	buffer	一个指针，
    			在fread()中表示存放输入数据的首地址；
    			在fwrite()中表示存放输出数据的首地址
    	size	数据块的字节数
    	count 	要读写的数据块块数
    	fp		文件指针
    */
    fread(buffer, size, count, fp);
    fwwrite(buffer, size, count, fp);
    
    /*
    	从 fp 所指的文件中，每次读 4 字节送入实数组 fa 中，连续读 5 次，即5个实数到 fa 中
    */
    fread(fa, 4, 5, fp);
    ```
  
  - 格式化读写函数 fscanf() fprintf()：格式化读写函数，其读写对象是磁盘文件。
  
    ```c
    fscanf(文件指针, 格式字符串, 输入列表);
    fprintf(文件指针, 格式字符串, 输出列表);
    ```
  
- 文件定位
  - rewind()：将文件位置指针移至文件起始处。
  
    ```c
    rewind(fp);
    ```
  
  - fseek()：将文件位置指针移至指定位置。
  
    ```c
    /*
    	fp			文件指针，指向被移动的文件。
    	位移量		  移动的字节数，要求位移量是 long 型数据，位移量可正可负，
    				位移量为正数时，位置指针向文件尾方向移动。
    				位移量为负数时，位置指针向文件头方向移动。
    	起始点		  位移量的参考点
    				0 代表文件开始位置
    				1 代表当前位置
    				2 代表文件尾位置
    */
    fseek(fp, 位移量, 起始点);
    
    /*
    	以文件开头为基准，文件位置指针向文件尾方向移动 50 字节
    */
    fseek(fp, 50L, 0); 
    ```
  
  - ftell()：查找位置指针的当前位置。
  
    ```c
    /*
    	返回值为文件位置指针当前位置相对于文件开始的偏移字节数
    	若函数调用出错，则返回 -1。
    */
    long n;
    n = ftell(fp);
    ```
  
  - feof()：判断文件位置指针是否在文件结束位置。
  
    ```c
    /*
    	当文件位置指针在文件末尾时，返回值为1，否则返回值为0。
    */
    feof(fp);
    ```
  
  - ferror()：
  
    ```c
    ferror(fp);
    ```
  
    - ferror() 函数的返回值为0，表示未出错；若返回值非0，表示出错。
    - 调用 ferror() 函数时，自动使相应文件的 ferror() 函数初值为0。
    - ferror() 函数反映最后一个函数调用的出错状态。
    - 执行 ferror() 函数时，初值自动置为 0。
  
  - clearerr()：使文件错误标志和文件结束标志置为0。
  
    ```c
    clearerr(文件指针);
    ```

## 常见错误

- 文件操作要素不全

- 打开方式有误

  ```c
  // 用只读方式打开文件，却试图向该文件写入数据，显然是不行的
  if((fp = fopen("test", "r")) == NULL)
  {
  	printf("Cannot open file!");
      exit(0);
  }
  fputs(str, fp);
  ```

- 文件位置指针混乱
